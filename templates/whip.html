<html>
	<head>
		<link rel="stylesheet" href="css/webrtc.css" />
		<!-- This adapter normalizes cross-browser differences in WebRTC APIs. Currently necessary in order to support Firefox. -->
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.1.2/adapter.min.js"
			integrity="sha512-l40eBFtXx+ve5RryIELC3y6/OM6Nu89mLGQd7fg1C93tN6XrkC3supb+/YiD/Y+B8P37kdJjtG1MT1kOO2VzxA=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
				background-color: #f5f5f5;
			}
			.container {
				background: white;
				padding: 30px;
				border-radius: 10px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
			}
			h1 {
				color: #333;
				text-align: center;
				margin-bottom: 30px;
			}
			.input-group {
				margin-bottom: 20px;
			}
			label {
				display: block;
				margin-bottom: 5px;
				font-weight: bold;
				color: #555;
			}
			input[type="text"] {
				width: 100%;
				padding: 12px;
				border: 2px solid #ddd;
				border-radius: 5px;
				font-size: 16px;
				box-sizing: border-box;
			}
			input[type="text"]:focus {
				border-color: #007bff;
				outline: none;
			}
			button {
				background: #007bff;
				color: white;
				padding: 12px 30px;
				border: none;
				border-radius: 5px;
				font-size: 16px;
				cursor: pointer;
				margin-right: 10px;
				transition: background-color 0.3s;
			}
			button:hover {
				background: #0056b3;
			}
			button:disabled {
				background: #ccc;
				cursor: not-allowed;
			}
			button.stop {
				background: #dc3545;
			}
			button.stop:hover {
				background: #c82333;
			}
			.video-container {
				margin-top: 20px;
				text-align: center;
			}
			#input-video {
				max-width: 100%;
				border-radius: 5px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
			}
			.status {
				margin-top: 15px;
				padding: 10px;
				border-radius: 5px;
				font-weight: bold;
			}
			.status.connecting {
				background: #fff3cd;
				color: #856404;
				border: 1px solid #ffeaa7;
			}
			.status.connected {
				background: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}
			.status.error {
				background: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>ğŸ“¤ WHIP æ¨æµå™¨</h1>
			<p style="text-align: center; color: #666; margin-bottom: 30px;">
				WebRTC-HTTP Ingest Protocol æ¨æµå™¨ - å°†æœ¬åœ°è§†é¢‘æ¨é€åˆ°æœåŠ¡å™¨
			</p>
			
			<div class="input-group">
				<label for="whip-url">WHIP æœåŠ¡å™¨åœ°å€:</label>
				<input type="text" id="whip-url" placeholder="ä¾‹å¦‚: https://your-server.com/whip/stream-key" />
			</div>
			
			<div style="text-align: center;">
				<button id="start-btn" onclick="startBroadcasting()">å¼€å§‹æ¨æµ</button>
				<button id="stop-btn" class="stop" onclick="stopBroadcasting()" disabled>åœæ­¢æ¨æµ</button>
			</div>
			
			<div id="status" class="status" style="display: none;"></div>
			
			<div class="video-container">
				<video id="input-video" autoplay muted></video>
			</div>
		</div>

		<script type="module">
			import WHIPClient from "../js/webrtc/WHIPClient.js";

			let client = null;
			let stream = null;

			window.startBroadcasting = async function() {
				const url = document.getElementById('whip-url').value.trim();
				if (!url) {
					showStatus('è¯·è¾“å…¥WHIPæœåŠ¡å™¨åœ°å€', 'error');
					return;
				}

				try {
					showStatus('æ­£åœ¨è·å–æ‘„åƒå¤´æƒé™...', 'connecting');
					
					// è·å–æ‘„åƒå¤´å’Œéº¦å…‹é£æƒé™
					stream = await navigator.mediaDevices.getUserMedia({
						video: true,
						audio: true
					});
					
					const videoElement = document.getElementById('input-video');
					videoElement.srcObject = stream;
					
					showStatus('æ­£åœ¨è¿æ¥WHIPæœåŠ¡å™¨...', 'connecting');
					
					// åˆ›å»ºWHIPå®¢æˆ·ç«¯
					client = new WHIPClient(url, videoElement);
					
					// ç›‘å¬è¿æ¥çŠ¶æ€
					client.on('connected', () => {
						showStatus('æ¨æµå·²å¼€å§‹ï¼', 'connected');
						document.getElementById('start-btn').disabled = true;
						document.getElementById('stop-btn').disabled = false;
					});
					
					client.on('error', (error) => {
						showStatus('æ¨æµé”™è¯¯: ' + error.message, 'error');
						document.getElementById('start-btn').disabled = false;
						document.getElementById('stop-btn').disabled = true;
					});
					
					client.on('disconnected', () => {
						showStatus('æ¨æµå·²åœæ­¢', 'error');
						document.getElementById('start-btn').disabled = false;
						document.getElementById('stop-btn').disabled = true;
					});
					
				} catch (error) {
					showStatus('è·å–æ‘„åƒå¤´æƒé™å¤±è´¥: ' + error.message, 'error');
				}
			};

			window.stopBroadcasting = function() {
				if (client) {
					client.disconnect();
					client = null;
				}
				
				if (stream) {
					stream.getTracks().forEach(track => track.stop());
					stream = null;
				}
				
				const videoElement = document.getElementById('input-video');
				videoElement.srcObject = null;
				
				showStatus('æ¨æµå·²åœæ­¢', 'error');
				document.getElementById('start-btn').disabled = false;
				document.getElementById('stop-btn').disabled = true;
			};

			function showStatus(message, type) {
				const statusDiv = document.getElementById('status');
				statusDiv.textContent = message;
				statusDiv.className = 'status ' + type;
				statusDiv.style.display = 'block';
			}

			// é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
			window.addEventListener('beforeunload', () => {
				if (client) {
					client.disconnect();
				}
				if (stream) {
					stream.getTracks().forEach(track => track.stop());
				}
			});
		</script>
	</body>
</html>
