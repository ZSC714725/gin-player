<html>
	<head>
		<link rel="stylesheet" href="css/webrtc.css" />
		<!-- This adapter normalizes cross-browser differences in WebRTC APIs. Currently necessary in order to support Firefox. -->
		<script
			src="https://cdnjs.cloudflare.com/ajax/libs/webrtc-adapter/8.1.2/adapter.min.js"
			integrity="sha512-l40eBFtXx+ve5RryIELC3y6/OM6Nu89mLGQd7fg1C93tN6XrkC3supb+/YiD/Y+B8P37kdJjtG1MT1kOO2VzxA=="
			crossorigin="anonymous"
			referrerpolicy="no-referrer"
		></script>
		<style>
			body {
				font-family: Arial, sans-serif;
				max-width: 800px;
				margin: 0 auto;
				padding: 20px;
				background-color: #f5f5f5;
			}
			.container {
				background: white;
				padding: 30px;
				border-radius: 10px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
			}
			h1 {
				color: #333;
				text-align: center;
				margin-bottom: 30px;
			}
			.input-group {
				margin-bottom: 20px;
			}
			label {
				display: block;
				margin-bottom: 5px;
				font-weight: bold;
				color: #555;
			}
			input[type="text"] {
				width: 100%;
				padding: 12px;
				border: 2px solid #ddd;
				border-radius: 5px;
				font-size: 16px;
				box-sizing: border-box;
			}
			input[type="text"]:focus {
				border-color: #007bff;
				outline: none;
			}
			button {
				background: #007bff;
				color: white;
				padding: 12px 30px;
				border: none;
				border-radius: 5px;
				font-size: 16px;
				cursor: pointer;
				margin-right: 10px;
				transition: background-color 0.3s;
			}
			button:hover {
				background: #0056b3;
			}
			button:disabled {
				background: #ccc;
				cursor: not-allowed;
			}
			button.stop {
				background: #dc3545;
			}
			button.stop:hover {
				background: #c82333;
			}
			.video-container {
				margin-top: 20px;
				text-align: center;
			}
			#input-video {
				max-width: 100%;
				border-radius: 5px;
				box-shadow: 0 2px 10px rgba(0,0,0,0.1);
			}
			.status {
				margin-top: 15px;
				padding: 10px;
				border-radius: 5px;
				font-weight: bold;
			}
			.status.connecting {
				background: #fff3cd;
				color: #856404;
				border: 1px solid #ffeaa7;
			}
			.status.connected {
				background: #d4edda;
				color: #155724;
				border: 1px solid #c3e6cb;
			}
			.status.error {
				background: #f8d7da;
				color: #721c24;
				border: 1px solid #f5c6cb;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<h1>📤 WHIP 推流器</h1>
			<p style="text-align: center; color: #666; margin-bottom: 30px;">
				WebRTC-HTTP Ingest Protocol 推流器 - 将本地视频推送到服务器
			</p>
			
			<div class="input-group">
				<label for="whip-url">WHIP 服务器地址:</label>
				<input type="text" id="whip-url" placeholder="例如: https://your-server.com/whip/stream-key" />
			</div>
			
			<div style="text-align: center;">
				<button id="start-btn" onclick="startBroadcasting()">开始推流</button>
				<button id="stop-btn" class="stop" onclick="stopBroadcasting()" disabled>停止推流</button>
			</div>
			
			<div id="status" class="status" style="display: none;"></div>
			
			<div class="video-container">
				<video id="input-video" autoplay muted></video>
			</div>
		</div>

		<script type="module">
			import WHIPClient from "../js/webrtc/WHIPClient.js";

			let client = null;
			let stream = null;

			window.startBroadcasting = async function() {
				const url = document.getElementById('whip-url').value.trim();
				if (!url) {
					showStatus('请输入WHIP服务器地址', 'error');
					return;
				}

				try {
					showStatus('正在获取摄像头权限...', 'connecting');
					
					// 获取摄像头和麦克风权限
					stream = await navigator.mediaDevices.getUserMedia({
						video: true,
						audio: true
					});
					
					const videoElement = document.getElementById('input-video');
					videoElement.srcObject = stream;
					
					showStatus('正在连接WHIP服务器...', 'connecting');
					
					// 创建WHIP客户端
					client = new WHIPClient(url, videoElement);
					
					// 监听连接状态
					client.on('connected', () => {
						showStatus('推流已开始！', 'connected');
						document.getElementById('start-btn').disabled = true;
						document.getElementById('stop-btn').disabled = false;
					});
					
					client.on('error', (error) => {
						showStatus('推流错误: ' + error.message, 'error');
						document.getElementById('start-btn').disabled = false;
						document.getElementById('stop-btn').disabled = true;
					});
					
					client.on('disconnected', () => {
						showStatus('推流已停止', 'error');
						document.getElementById('start-btn').disabled = false;
						document.getElementById('stop-btn').disabled = true;
					});
					
				} catch (error) {
					showStatus('获取摄像头权限失败: ' + error.message, 'error');
				}
			};

			window.stopBroadcasting = function() {
				if (client) {
					client.disconnect();
					client = null;
				}
				
				if (stream) {
					stream.getTracks().forEach(track => track.stop());
					stream = null;
				}
				
				const videoElement = document.getElementById('input-video');
				videoElement.srcObject = null;
				
				showStatus('推流已停止', 'error');
				document.getElementById('start-btn').disabled = false;
				document.getElementById('stop-btn').disabled = true;
			};

			function showStatus(message, type) {
				const statusDiv = document.getElementById('status');
				statusDiv.textContent = message;
				statusDiv.className = 'status ' + type;
				statusDiv.style.display = 'block';
			}

			// 页面卸载时清理资源
			window.addEventListener('beforeunload', () => {
				if (client) {
					client.disconnect();
				}
				if (stream) {
					stream.getTracks().forEach(track => track.stop());
				}
			});
		</script>
	</body>
</html>
